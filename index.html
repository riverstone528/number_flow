<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë„˜ë²„ í”Œë¡œìš°</title>
<link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #fff9f0;
    --surface:  #ffffff;
    --card:     #fffdf8;
    --border:   #f0e6d3;
    --sky:      #5bc8f5;
    --grass:    #6dd47e;
    --sun:      #ffcc44;
    --coral:    #ff7c6e;
    --lavender: #b39ddb;
    --peach:    #ffb347;
    --text:     #3d2c1e;
    --muted:    #b0948a;
    --white:    #ffffff;
  }

  /* ëª¨ë°”ì¼ í™”ë©´ ê³ ì • ë° ìŠ¤í¬ë¡¤ ë°©ì§€ */
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100dvh;
    overflow: hidden;
    position: fixed;
    overscroll-behavior: none;
  }

  * { 
    margin:0; 
    padding:0; 
    box-sizing:border-box; 
    -webkit-tap-highlight-color:transparent; 
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans KR', sans-serif;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    touch-action: none;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60px 40px at 10% 12%, rgba(91,200,245,0.18) 0%, transparent 100%),
      radial-gradient(ellipse 90px 55px at 80% 8%,  rgba(91,200,245,0.13) 0%, transparent 100%),
      radial-gradient(ellipse 50px 35px at 55% 5%,  rgba(91,200,245,0.10) 0%, transparent 100%),
      radial-gradient(circle 3px at 20% 25%, rgba(255,204,68,0.6) 0%, transparent 100%),
      radial-gradient(circle 2px at 75% 18%, rgba(255,204,68,0.5) 0%, transparent 100%),
      radial-gradient(circle 3px at 45% 35%, rgba(255,204,68,0.4) 0%, transparent 100%),
      radial-gradient(circle 2px at 90% 40%, rgba(255,204,68,0.5) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  .app {
    width: 100%;
    max-width: 420px;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
    overflow: hidden;
  }

  .screen { display: none; flex-direction: column; flex: 1; height: 100%; }
  .screen.active { display: flex; }

  /* HOME */
  .logo-wrap { text-align: center; padding: 0.5rem 0 0; }
  .logo-icon {
    display: block;
    margin: 0 auto;
    animation: float 3s ease-in-out infinite;
    filter: drop-shadow(0 8px 16px rgba(91,200,245,0.25)) drop-shadow(0 4px 8px rgba(255,124,110,0.2));
    width: 110px; height: 110px;
  }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
  .logo-title {
    font-family: 'Gaegu', cursive;
    font-size: 2.4rem;
    font-weight: 700;
    color: var(--coral);
    text-shadow: 3px 3px 0 rgba(255,124,110,0.2);
    margin-top: 0.2rem;
  }
  .logo-sub { font-family: 'Gaegu', cursive; font-size: 1rem; color: var(--muted); margin-top: 0.1rem; }
  
  .home-desc {
    background: var(--white);
    border: 2.5px solid var(--border);
    border-radius: 20px;
    padding: 1rem 1.2rem;
    font-size: 0.88rem;
    color: var(--muted);
    line-height: 1.8;
    text-align: center;
    box-shadow: 0 4px 0 var(--border);
    position: relative;
    margin: 0 1.2rem;
  }
  .home-desc::before { content:'ğŸ’¡'; position:absolute; top:-14px; left:50%; transform:translateX(-50%); font-size:1.3rem; }
  .home-desc strong { color: var(--coral); font-weight: 700; }
  
  .section-label { font-family:'Gaegu',cursive; font-size:1.1rem; color:var(--muted); margin-bottom:0.2rem; padding: 0 1.2rem; }
  .levels-grid { display:flex; flex-direction:column; gap:0.8rem; width:100%; padding: 0 1.2rem; }
  
  .level-btn {
    background: var(--white);
    border: 2.5px solid var(--border);
    border-radius: 20px;
    padding: 1rem 1.2rem;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    display: flex;
    align-items: center;
    gap: 0.9rem;
    text-align: left;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 0 var(--border);
  }
  .level-btn:active { transform:translateY(3px); box-shadow:0 1px 0 var(--border); }
  .level-btn::before { content:''; position:absolute; left:0; top:0; bottom:0; width:5px; border-radius:20px 0 0 20px; }
  #btn-easy::before   { background: var(--grass); }
  #btn-medium::before { background: var(--sky); }
  #btn-hard::before   { background: var(--coral); }
  
  .level-icon { font-size:2rem; flex-shrink:0; }
  .level-info { flex:1; display:flex; flex-direction:column; gap:0.2rem; }
  .level-top  { display:flex; align-items:center; gap:0.5rem; }
  .level-name { font-family:'Gaegu',cursive; font-size:1.2rem; font-weight:700; color:var(--text); }
  .level-stars { font-size:0.65rem; color:var(--sun); letter-spacing:2px; }
  .level-desc  { font-size:0.75rem; color:var(--muted); line-height:1.4; }
  .level-best  { font-family:'Gaegu',cursive; font-size:0.95rem; font-weight:700; color:var(--peach); flex-shrink:0; white-space:nowrap; }

  /* GAME SCREEN UI */
  #gameScreen { padding:0; position:relative; background:var(--bg); }
  .game-header {
    padding:0.9rem 1.2rem; display:flex; align-items:center; gap:0.8rem;
    background:var(--white); border-bottom:2.5px solid var(--border);
  }
  .back-btn {
    width:40px; height:40px; border-radius:50%;
    border:2.5px solid var(--border); background:var(--bg); color:var(--text);
    font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center;
    flex-shrink:0; transition:transform 0.15s; box-shadow:0 3px 0 var(--border);
  }
  .back-btn:active { transform:translateY(2px); box-shadow:0 1px 0 var(--border); }
  
  .game-info { flex:1; }
  .level-label { font-family:'Gaegu',cursive; font-size:0.8rem; color:var(--muted); }
  .puzzle-num  { font-family:'Gaegu',cursive; font-size:1.1rem; font-weight:700; color:var(--text); }
  
  .timer-wrap {
    padding:0.65rem 1.2rem; background:var(--white); border-bottom:2.5px solid var(--border);
    display:flex; align-items:center; gap:0.8rem;
  }
  .timer-label { font-family:'Gaegu',cursive; font-size:0.8rem; color:var(--muted); flex-shrink:0; width:4.5rem; }
  .timer-val {
    font-family:'Gaegu',cursive; font-size:1.2rem; font-weight:700; color:var(--text);
    flex-shrink:0; width:6rem; text-align:right; font-variant-numeric:tabular-nums; white-space:nowrap;
  }
  
  .q-dots { display:flex; gap:7px; align-items:center; flex:1; justify-content:center; }
  .q-dot { width:10px; height:10px; border-radius:50%; background:var(--border); transition:all 0.3s; }
  .q-dot.done    { background:var(--grass); box-shadow:0 0 0 2px rgba(109,212,126,0.3); }
  .q-dot.current { background:var(--sun); box-shadow:0 0 0 3px rgba(255,204,68,0.3); transform:scale(1.35); }
  
  .target-area {
    margin:1rem 1.2rem 0.5rem;
    background:var(--white); border:2.5px solid var(--border); border-radius:24px;
    padding:1rem 1.5rem; display:flex; flex-direction:column; align-items:center; gap:0.5rem;
    box-shadow:0 4px 0 var(--border); transition:border-color 0.2s, background 0.2s;
  }
  .target-label { font-family:'Gaegu',cursive; font-size:0.85rem; color:var(--muted); }
  
  @keyframes slideInDown {
    0%  { transform:translateY(-20px); opacity:0; }
    60% { transform:translateY(2px);   opacity:1; }
    100%{ transform:translateY(0);     opacity:1; }
  }
  .target-area.slide-in { animation:slideInDown 0.35s cubic-bezier(0.22,1,0.36,1) forwards; }
  
  @keyframes wrongShake {
    0%,100%{transform:translateX(0)} 15%{transform:translateX(-8px)} 35%{transform:translateX(8px)} 55%{transform:translateX(-5px)} 75%{transform:translateX(5px)}
  }
  .target-area.wrong { animation:wrongShake 0.4s ease; border-color:var(--coral); background:rgba(255,124,110,0.06); }
  
  .hint-formula { display:flex; align-items:center; justify-content:center; gap:0.5rem; flex-wrap:wrap; }
  .hint-box {
    font-family:'Gaegu',cursive; font-size:2rem; font-weight:700;
    min-width:3rem; height:3.2rem; display:flex; align-items:center; justify-content:center;
    border-radius:14px; border:2.5px dashed var(--border); background:var(--bg); color:var(--muted);
    transition:all 0.15s; padding:0 0.4rem; box-shadow:0 3px 0 var(--border);
  }
  .hint-box.filled {
    border-style:solid; border-color:var(--sky); background:rgba(91,200,245,0.12); color:#1a8ab5;
    box-shadow:0 3px 0 rgba(91,200,245,0.4); animation:popIn 0.2s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes popIn { 0%{transform:scale(0.75)} 100%{transform:scale(1)} }
  .hint-box.wrong-flash {
    border-style:solid !important; border-color:var(--coral) !important;
    background:rgba(255,124,110,0.12) !important; color:var(--coral) !important;
    box-shadow:0 3px 0 rgba(255,124,110,0.3) !important;
  }
  .hint-op, .hint-eq { font-family:'Gaegu',cursive; font-size:1.8rem; font-weight:700; color:var(--muted); }
  .hint-target { font-family:'Gaegu',cursive; font-size:2rem; font-weight:700; color:var(--coral); text-shadow:2px 2px 0 rgba(255,124,110,0.2); }
  
  .grid-wrap { padding:0.5rem 1.2rem; flex:1; }
  .num-grid  { display:grid; gap:8px; }
  .num-cell {
    aspect-ratio:1; border-radius:16px; background:var(--white); border:2.5px solid var(--border);
    display:flex; align-items:center; justify-content:center;
    font-family:'Gaegu',cursive; font-size:1.5rem; font-weight:700;
    cursor:pointer; transition:transform 0.12s, box-shadow 0.12s, border-color 0.12s, background 0.12s;
    user-select:none; -webkit-user-select:none; box-shadow:0 3px 0 var(--border); color:var(--text);
    position:relative;
  }
  .num-cell:active  { transform:translateY(2px); box-shadow:0 1px 0 var(--border); }
  .num-cell.selected {
    border-color:var(--sky); background:rgba(91,200,245,0.15); color:#1a8ab5;
    box-shadow:0 3px 0 rgba(91,200,245,0.4); transform:translateY(-2px) scale(1.05);
  }
  .num-cell.used {
    background: var(--grass); border-color: #4db863; color: #fff;
    cursor: default; box-shadow: 0 4px 0 #4db863;
    animation: cellFillGreen 0.3s ease forwards;
  }
  @keyframes cellFillGreen {
    0%   { background: var(--white); border-color: var(--border); color: var(--text); }
    100% { background: var(--grass); border-color: #4db863; color: #fff; box-shadow: 0 4px 0 #4db863; }
  }

  /* COUNTDOWN UI [ìˆ˜ì •ë¨] */
  .countdown-overlay {
    display:none; position:absolute; inset:0; background:rgba(255,249,240,0.9);
    backdrop-filter:blur(4px); z-index:50; align-items:center; justify-content:center; flex-direction:column; gap:0.5rem;
  }
  .countdown-overlay.show { display:flex; }
  .countdown-num {
    font-family:'Gaegu',cursive; font-size:8rem; font-weight:700; color:var(--coral);
    text-align:center; width:100%;
    animation: countPop 0.9s ease infinite; /* ì• ë‹ˆë©”ì´ì…˜ ì¬ì •ì˜ */
  }
  .countdown-label { font-family:'Gaegu',cursive; font-size:1.1rem; color:var(--muted); }
  @keyframes countPop { 
    0% { transform: scale(1.5); opacity: 0; } 
    50% { transform: scale(1); opacity: 1; } 
    100% { transform: scale(0.8); opacity: 0; } 
  }

  /* RESULT OVERLAY */
  .overlay {
    display:none; position:fixed; inset:0; background:rgba(61,44,30,0.45);
    backdrop-filter:blur(6px); z-index:100; flex-direction:column;
    align-items:center; justify-content:center; padding:1.5rem;
  }
  .overlay.show { display:flex; }
  .result-card {
    background:var(--white); border:3px solid var(--border); border-radius:28px;
    padding:2rem 1.8rem; width:100%; max-width:340px; text-align:center;
    box-shadow:0 8px 0 var(--border);
  }
  .result-time-val { font-family:'Gaegu',cursive; font-size:3rem; font-weight:700; color:var(--text); }
  .action-btn {
    width: 100%; padding:0.85rem; border-radius:16px; border:2.5px solid var(--border);
    background:var(--white); color:var(--text); font-family:'Gaegu',cursive; font-size:1.1rem;
    cursor:pointer; margin-top: 0.7rem; box-shadow:0 4px 0 var(--border);
  }
  .action-btn.primary { background:var(--grass); color:var(--white); border-color:#4db863; box-shadow:0 4px 0 #4db863; }

  /* PARTICLES */
  .star-particle { position: fixed; pointer-events: none; z-index: 95; animation: starFly 1s linear forwards; }
  @keyframes starFly {
    0% { transform: translate(0,0) scale(1.2); opacity: 1; }
    100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
  }
  .confetti-piece { position:fixed; width:10px; height:10px; border-radius:3px; pointer-events:none; z-index:200; }
</style>
</head>
<body>
<div class="app">

  <div class="screen active" id="homeScreen">
    <div style="padding:1.5rem 0 2rem; display:flex; flex-direction:column; gap:1.2rem; flex:1;">
      <div class="logo-wrap">
        <span class="logo-icon">
          <svg width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="4" y="62" width="36" height="36" rx="8" fill="#ff7c6e"/>
            <rect x="4" y="62" width="36" height="10" rx="8" fill="#ff9f95"/>
            <ellipse cx="15" cy="76" rx="4.5" ry="5" fill="white"/>
            <ellipse cx="29" cy="76" rx="4.5" ry="5" fill="white"/>
            <circle cx="16.5" cy="77" r="2.5" fill="#2d1a0e"/>
            <circle cx="30.5" cy="77" r="2.5" fill="#2d1a0e"/>
            <path d="M14 86 Q22 91 30 86" stroke="#2d1a0e" stroke-width="2" stroke-linecap="round" fill="none"/>
            <text x="22" y="97" font-family="'Gaegu',cursive" font-size="10" font-weight="700" fill="white" text-anchor="middle">3</text>
            
            <rect x="70" y="62" width="36" height="36" rx="8" fill="#6dd47e"/>
            <rect x="70" y="62" width="36" height="10" rx="8" fill="#90e09e"/>
            <ellipse cx="81" cy="76" rx="4.5" ry="5" fill="white"/>
            <ellipse cx="95" cy="76" rx="4.5" ry="5" fill="white"/>
            <circle cx="82.5" cy="77" r="2.5" fill="#2d1a0e"/>
            <circle cx="96.5" cy="77" r="2.5" fill="#2d1a0e"/>
            <path d="M80 86 Q88 91 96 86" stroke="#2d1a0e" stroke-width="2" stroke-linecap="round" fill="none"/>
            <text x="88" y="97" font-family="'Gaegu',cursive" font-size="10" font-weight="700" fill="white" text-anchor="middle">1</text>
            
            <rect x="28" y="8" width="54" height="54" rx="12" fill="#5bc8f5"/>
            <rect x="28" y="8" width="54" height="16" rx="12" fill="#7dd6f8"/>
            <ellipse cx="42" cy="30" rx="7" ry="8" fill="white"/>
            <ellipse cx="64" cy="30" rx="7" ry="8" fill="white"/>
            <circle cx="44" cy="31.5" r="4" fill="#2d1a0e"/>
            <circle cx="66" cy="31.5" r="4" fill="#2d1a0e"/>
            <path d="M40 44 Q53 52 66 44" stroke="#2d1a0e" stroke-width="2.5" stroke-linecap="round" fill="none"/>
            <text x="55" y="58" font-family="'Gaegu',cursive" font-size="14" font-weight="700" fill="white" text-anchor="middle">2</text>
          </svg>
        </span>
        <div class="logo-title">ë„˜ë²„ í”Œë¡œìš°</div>
        <div class="logo-sub">5ë¬¸ì œë¥¼ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ í’€ì–´ë¼!</div>
      </div>
      <div class="home-desc">
        ìˆ«ìë¥¼ íƒ­í•´ì„œ ê³ ë¥´ê³ ,<br>
        í•©ê³„ê°€ <strong>ëª©í‘œ ìˆ«ì</strong>ì™€ ë§ìœ¼ë©´ ìë™ìœ¼ë¡œ ë„˜ì–´ê°€ìš”!<br>
        <strong>5ë¬¸ì œ</strong>ë¥¼ ê°€ì¥ ë¹ ë¥´ê²Œ í‘¸ëŠ” ê²Œ ëª©í‘œ ğŸ¯
      </div>
      <div>
        <div class="section-label">âœï¸ ë‚œì´ë„ë¥¼ ì„ íƒí•´ìš”</div>
        <div class="levels-grid">
          <div class="level-btn" onclick="startGame('easy')" id="btn-easy">
            <span class="level-icon">ğŸ£</span>
            <div class="level-info">
              <div class="level-top"><span class="level-name">ì‰¬ì›€</span><span class="level-stars">â˜…â˜†â˜†</span></div>
              <span class="level-desc">3Ã—3 ì¹¸ Â· 1~9 ìˆ«ì Â· 2ê°œ ë”í•˜ê¸°</span>
            </div>
            <span class="level-best" id="best-easy"></span>
          </div>
          <div class="level-btn" onclick="startGame('medium')" id="btn-medium">
            <span class="level-icon">ğŸ¬</span>
            <div class="level-info">
              <div class="level-top"><span class="level-name">ë³´í†µ</span><span class="level-stars">â˜…â˜…â˜†</span></div>
              <span class="level-desc">4Ã—4 ì¹¸ Â· 1~20 ìˆ«ì Â· 2ê°œ ë”í•˜ê¸°</span>
            </div>
            <span class="level-best" id="best-medium"></span>
          </div>
          <div class="level-btn" onclick="startGame('hard')" id="btn-hard">
            <span class="level-icon">ğŸ¦</span>
            <div class="level-info">
              <div class="level-top"><span class="level-name">ì–´ë ¤ì›€</span><span class="level-stars">â˜…â˜…â˜…</span></div>
              <span class="level-desc">4Ã—4 ì¹¸ Â· 1~10 ìˆ«ì Â· 3ê°œ ë”í•˜ê¸°</span>
            </div>
            <span class="level-best" id="best-hard"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="screen" id="gameScreen">
    <div class="countdown-overlay" id="countdownOverlay">
      <div class="countdown-num" id="countdownNum">3</div>
      <div class="countdown-label">ì¤€ë¹„í•˜ì„¸ìš”! ğŸµ</div>
    </div>
    <div class="game-header">
      <button class="back-btn" onclick="goHome()">â†</button>
      <div class="game-info">
        <div class="level-label" id="levelLabel">EASY</div>
        <div class="puzzle-num" id="puzzleNum">1 / 5</div>
      </div>
    </div>
    <div class="timer-wrap">
      <span class="timer-label">â± ì´ ì‹œê°„</span>
      <div class="q-dots" id="qDots"></div>
      <span class="timer-val" id="timerDisp">0.0ì´ˆ</span>
    </div>
    <div class="target-area">
      <div class="target-label">ğŸ¯ ëª©í‘œ í•©ê³„</div>
      <div class="hint-formula" id="hintFormula"></div>
    </div>
    <div class="grid-wrap">
      <div class="num-grid" id="numGrid"></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="result-card" id="resultCard">
    <div class="result-icon" id="resIcon">ğŸ‰</div>
    <div class="result-title" id="resTitle">ì™„ë£Œ!</div>
    <div class="result-time-val" id="resTotalTime">0.0ì´ˆ</div>
    <div class="result-btns">
      <button class="action-btn primary" onclick="replayLevel()">â†º í•œ ë²ˆ ë”!</button>
      <button class="action-btn" onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
    </div>
  </div>
</div>

<script>
// ëª¨ë°”ì¼ ë“œë˜ê·¸ ë° í™•ëŒ€ ë°©í•© ë°©ì§€
document.addEventListener('touchmove', function(e) {
    if (e.scale !== 1) { e.preventDefault(); }
}, { passive: false });

const TOTAL_Q = 5;
const LEVELS = {
  easy:   { gridSize: 3, maxNum: 9,  solCount: 2 },
  medium: { gridSize: 4, maxNum: 20, solCount: 2 },
  hard:   { gridSize: 4, maxNum: 10, solCount: 3 },
};

let state = {
  level: 'easy', numbers: [], target: 0, selected: [], _solution: [],
  qIndex: 0, qTimes: [], qStart: 0, elapsed: 0, timerInterval: null,
  best: { easy: null, medium: null, hard: null }
};

updateHomeDisplay();

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function goHome() {
  clearInterval(state.timerInterval);
  document.getElementById('overlay').classList.remove('show');
  updateHomeDisplay();
  showScreen('homeScreen');
}

function updateHomeDisplay() {
  ['easy','medium','hard'].forEach(level => {
    const best = state.best[level];
    document.getElementById(`best-${level}`).textContent = best !== null ? `ğŸ† ${(best/10).toFixed(1)}ì´ˆ` : '';
  });
}

function startGame(level) {
  state.level = level; state.qIndex = 0; state.qTimes = []; state.elapsed = 0; state.selected = [];
  loadQuestion();
  showScreen('gameScreen');
  startCountdown(() => startTimer());
}

function loadQuestion() {
  const cfg = LEVELS[state.level];
  const size = cfg.gridSize * cfg.gridSize;
  state.selected = [];
  state.qStart = state.elapsed;

  const solCount = cfg.solCount;
  const solutionNums = Array.from({length: solCount}, () => Math.floor(Math.random() * cfg.maxNum) + 1);
  state.target = solutionNums.reduce((s, n) => s + n, 0);

  state.numbers = Array.from({length: size}, () => Math.floor(Math.random() * cfg.maxNum) + 1);
  const idxs = shuffle([...Array(size).keys()]).slice(0, solCount);
  idxs.forEach((idx, i) => { state.numbers[idx] = solutionNums[i]; });
  state._solution = idxs;
  state._hint = solutionNums[0];

  document.getElementById('levelLabel').textContent = state.level.toUpperCase();
  document.getElementById('puzzleNum').textContent  = `${state.qIndex + 1} / ${TOTAL_Q}`;
  renderDots(); renderGrid(); renderFormula();
}

function renderDots() {
  const wrap = document.getElementById('qDots'); wrap.innerHTML = '';
  for (let i = 0; i < TOTAL_Q; i++) {
    const d = document.createElement('div');
    d.className = 'q-dot' + (i < state.qIndex ? ' done' : i === state.qIndex ? ' current' : '');
    wrap.appendChild(d);
  }
}

function renderGrid() {
  const cfg = LEVELS[state.level];
  const grid = document.getElementById('numGrid');
  grid.style.gridTemplateColumns = `repeat(${cfg.gridSize}, 1fr)`;
  grid.innerHTML = '';
  state.numbers.forEach((n, i) => {
    const cell = document.createElement('div');
    cell.className = 'num-cell';
    cell.textContent = n;
    cell.dataset.idx = i;
    cell.onclick = () => toggleCell(i, cell);
    grid.appendChild(cell);
  });
}

function toggleCell(idx, cell) {
  if (cell.classList.contains('used')) return;
  const pos = state.selected.indexOf(idx);
  if (pos >= 0) { state.selected.splice(pos, 1); cell.classList.remove('selected'); }
  else          { state.selected.push(idx);       cell.classList.add('selected'); }
  renderFormula();

  const needed = state._solution.length - 1;
  if (state.selected.length === needed) {
    const sum = state._hint + state.selected.reduce((s, i) => s + state.numbers[i], 0);
    if (sum === state.target) submitAnswer(); else showWrong();
  }
}

function showWrong() {
  document.querySelectorAll('.hint-box').forEach(b => b.classList.add('wrong-flash'));
  const area = document.querySelector('.target-area');
  area.classList.add('wrong');
  setTimeout(() => {
    state.selected = [];
    document.querySelectorAll('.num-cell').forEach(c => c.classList.remove('selected'));
    area.classList.remove('wrong');
    renderFormula();
  }, 400);
}

function renderFormula() {
  const wrap = document.getElementById('hintFormula'); wrap.innerHTML = '';
  const box0 = document.createElement('div'); box0.className = 'hint-box filled'; box0.textContent = state._hint;
  wrap.appendChild(box0);

  for (let i = 0; i < state._solution.length - 1; i++) {
    const op = document.createElement('span'); op.className='hint-op'; op.textContent='+'; wrap.appendChild(op);
    const box = document.createElement('div');
    box.className = 'hint-box' + (i < state.selected.length ? ' filled' : '');
    box.textContent = i < state.selected.length ? state.numbers[state.selected[i]] : '?';
    wrap.appendChild(box);
  }
  const eq = document.createElement('span'); eq.className='hint-eq'; eq.textContent='='; wrap.appendChild(eq);
  const tgt = document.createElement('span'); tgt.className='hint-target'; tgt.textContent=state.target; wrap.appendChild(tgt);
}

function submitAnswer() {
  state.qTimes.push(state.elapsed - state.qStart);
  state.selected.forEach(i => {
    const cell = document.querySelector(`.num-cell[data-idx="${i}"]`);
    if (cell) {
      cell.classList.add('used');
      const rect = cell.getBoundingClientRect();
      launchStars(rect.left + rect.width / 2, rect.top + rect.height / 2);
    }
  });

  state.qIndex++;
  if (state.qIndex >= TOTAL_Q) {
    clearInterval(state.timerInterval);
    setTimeout(() => showResult(), 600);
  } else {
    setTimeout(() => loadQuestion(), 600);
  }
}

function showResult() {
  const totalSec = (state.elapsed / 10).toFixed(1);
  const isNew = state.best[state.level] === null || state.elapsed < state.best[state.level];
  if (isNew) state.best[state.level] = state.elapsed;

  document.getElementById('resTitle').textContent = isNew ? 'ìµœê³ ê¸°ë¡ ê°±ì‹ !' : 'ì™„ë£Œ!';
  document.getElementById('resTotalTime').textContent = `${totalSec}ì´ˆ`;
  document.getElementById('overlay').classList.add('show');
  launchConfetti();
}

function replayLevel() {
  document.getElementById('overlay').classList.remove('show');
  startGame(state.level);
}

function startTimer() {
  state.timerInterval = setInterval(() => {
    state.elapsed++;
    document.getElementById('timerDisp').textContent = `${(state.elapsed/10).toFixed(1)}ì´ˆ`;
  }, 100);
}

function startCountdown(onDone) {
  const overlay = document.getElementById('countdownOverlay');
  const numEl = document.getElementById('countdownNum');
  let count = 3; overlay.classList.add('show');
  
  // ì¹´ìš´íŠ¸ë‹¤ìš´ ì´ˆê¸°í™”
  numEl.textContent = count;
  
  const tick = setInterval(() => {
    count--;
    if (count <= 0) { 
      clearInterval(tick); 
      numEl.textContent = 'GO!'; 
      setTimeout(() => { overlay.classList.remove('show'); onDone(); }, 700); 
    } else { 
      numEl.textContent = count; 
    }
  }, 1000);
}

function shuffle(arr) {
  for (let i = arr.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  return arr;
}

function launchStars(cx, cy) {
  for (let i = 0; i < 10; i++) {
    const star = document.createElement('div');
    star.className = 'star-particle'; star.textContent = 'â­';
    star.style.left = cx + 'px'; star.style.top = cy + 'px';
    const angle = (i / 10) * 360;
    star.style.setProperty('--tx', Math.cos(angle) * 100 + 'px');
    star.style.setProperty('--ty', Math.sin(angle) * 100 + 'px');
    document.body.appendChild(star);
    setTimeout(() => star.remove(), 1000);
  }
}

function launchConfetti() {
  for (let i = 0; i < 50; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = Math.random()*100+'vw';
    el.style.background = ['#6dd47e','#5bc8f5','#ffcc44','#ff7c6e'][Math.floor(Math.random()*4)];
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }
}
</script>
</body>
</html>
